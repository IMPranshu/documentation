---
# Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
title: "HTTP/2"
---
<p>
    This document contains HTTP/2 performance considerations on the container -
    see <a href="container-tuning.html">Container tuning</a> for general tuning of container clusters.
</p>

<h2>Enabling HTTP/2 on container</h2>
<p>
    HTTP/2 is enabled on a container for all connectors with TLS/HTTPS configured (requires Vespa 7.418.23 or newer).
    Both HTTP/1.1 and HTTP/2 will be served over the same connector using the <a href="https://datatracker.ietf.org/doc/html/rfc7301">TLS ALPN Extension</a>.
    The Application-Layer Protocol Negotiation (ALPN) extension allows the client to send a list of supported protocols during TLS handshake.
    The container selects a supported protocol from that list.
</p>
<p>
    The <a href="https://datatracker.ietf.org/doc/html/rfc7540">HTTP/2 specification</a> dictates multiple requirements for TLS connection.
    Vespa may enforce some or all of these restrictions. See the HTTP/2 specification for the full list. The most significant are listed below:
</p>
<ul>
    <li>Client must use least TLSv1.2.</li>
    <li>Client must provided target domain in TLS Server Name Indication (SNI) Extension.</li>
    <li>Client must not use any of the banned <a href="https://datatracker.ietf.org/doc/html/rfc7540#appendix-A">TLSv1.2 ciphers</a>.</li>
</ul>

<h2>Feeding over HTTP/2</h2>
<p>
    One of the major improvements with HTTP/2 is multiplexing of multiple concurrent requests over a single TCP connections.
    This allows for high-throughput feeding over the <a href="/en/reference/document-v1-api-reference.html">Document v1 HTTP API</a>
    without the overhead with hundreds of parallel connections that HTTP/1.1 would incur.
    HTTP/2 + Document v1 is a great alternative to <a href="/en/vespa-http-client.html">Vespa HTTP Client</a>
    which does not require a JDK 8+ environment for the client to live in.
</p>
<p>
    Vespa provides a Java implementation of HTTP/2 + Document v1 in <a href="/en/vespa-feed-client.html">vespa-feed-client</a>.
    This client is available both as a Java API and a command line client.
</p>

<h2>Performance tuning</h2>
<h3>Client</h3>
<p>
    The number of multiple concurrent requests per connection is typically adjustable on HTTP/2 clients/libraries.
    Document v1 API is designed for high concurrency and can easily handle several hundred concurrent requests.
    Its implementation is asynchronous and max concurrency is not restricted directly by any thread pool size
    - you may configure your client to use several hundred concurrent streams per connection for this API.
    Other APIs such as the <a href="/en/query-api.html">Query API</a> is backed by a synchronous implementation,
    and max concurrency is restricted by the <a href="/en/performance/container-tuning.html#container-worker-threads">underlying thread pool size</a>.
    Too many concurrent streams may result in the container rejecting requests with 503 responses.
</p>
<p>
    There are still good arguments for using multiple TCP connections - even with HTTP/2.
</p>
<ul>
    <li><strong>Utilize multiple containers</strong>.
        A single container may not saturate the content layer.
        A client may have to use more connections than container nodes if the containers are behind a load balancer.</li>
    <li><strong>Higher throughput</strong>.
        Many clients allow for a single thread to operation on a single connection.
        Multiple connections may be required for utilizing several CPU cores.
    </li>
</ul>

<h2>Client recommendations</h2>
<p>
    Use <a href="/en/vespa-feed-client.html">vespa-feed-client</a> for feeding through Document v1 API (JDK8+).
</p>
<p>
    We recommend the <a href="https://nghttp2.org/documentation/h2load-howto.html">h2load benchmarking tool</a> for load testing.
    <a href="/en/reference/vespa-cmdline-tools.html#vespa-fbench">vespa-fbench</a> does not support HTTP/2 at the moment.
</p>
<p>
    For Java there are 4 good alternatives:
</p>
<ol>
    <li><a href="https://www.eclipse.org/jetty/javadoc/jetty-9/org/eclipse/jetty/client/HttpClient.html">Jetty Client</a>
    <li><a href="https://square.github.io/okhttp/">OkHttp</a></li>
    <li><a href="https://hc.apache.org/httpcomponents-client-5.1.x/">Apache HttpClient 5.x</a></li>
    <li><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpClient.html">java.net.http.HttpClient (JDK11+)</a> </li>
</ol>
